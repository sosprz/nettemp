#! /bin/bash

dir=$( cd "$( dirname "$0" )" && cd ../../ && pwd )
date=$(date +%y%m%d-%H%M)

function buzzer {
buzzer=$(sqlite3 $dir/dbf/nettemp.db "SELECT gpio FROM gpio where mode='buzzer'")
if [ -n "$buzzer" ]
	    then
		/usr/local/bin/gpio -g write $buzzer 1 &&  /usr/local/bin/gpio -g write $buzzer 0
	fi
}

gpio_on(){
    rev=$(sqlite3 $dir/dbf/nettemp.db "SELECT rev FROM gpio WHERE gpio='$1'")
    echo "$[($(date +%s)+7200)*1000],$[1]" >> $dir/tmp/gpio/gpio$1    
    /usr/local/bin/gpio -g mode $1 output
    if [ "$rev" = "on" ]; then
	/usr/local/bin/gpio -g write $1 0
	buzzer	
    elif [ "$rev" = "" ]; then
        /usr/local/bin/gpio -g write $1 1
	buzzer
    fi
}
gpio_off(){
    rev=$(sqlite3 $dir/dbf/nettemp.db "SELECT rev FROM gpio WHERE gpio='$1'")
    echo "$[($(date +%s)+7200)*1000],$[0]" >> $dir/tmp/gpio/gpio$1    
    /usr/local/bin/gpio -g mode $1 output
    if [ "$rev" = "on" ]; then 
        /usr/local/bin/gpio -g write $1 1
    elif [ "$rev" = "" ]; then 
	/usr/local/bin/gpio -g write $1 0
    fi
}

if [ -z "$gpio_list" ]; then
	gpio_list=$(sqlite3 $dir/dbf/nettemp.db "SELECT gpio FROM gpio")
fi


for gpio in $gpio_list; do 
	mode=$(sqlite3 $dir/dbf/nettemp.db "SELECT mode FROM gpio WHERE gpio='$gpio'")

if [ "$mode" = "time" ]; then
    source $(dirname $0)/time
elif [ "$mode" = "temp" ]; then
    source $(dirname $0)/temp
elif [ "$mode" = "trigger" ]; then
    source $(dirname $0)/trigger
elif [ "$mode" = "day" ]; then
    source $(dirname $0)/day
elif [ "$mode" = "week" ]; then
    source $(dirname $0)/week
fi
done

#onoff=`sqlite3 $dir/dbf/nettemp.db "SELECT gpio FROM settings"`
#if [ "$onoff" = "on" ];then
    
#    echo "on"
    
#else
#    echo "GPIO OFF"
#fi


